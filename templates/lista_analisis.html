{% extends "base.html" %}

{% block title %}Mis Análisis - Subastas Visual{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>Mis Análisis de Subastas</h2>
            <hr>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <a href="{{ url_for('nuevo_analisis') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Nuevo Análisis
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
    </div>

    {% if analisis %}
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Total: {{ analisis|length }} análisis</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="thead-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Identificador</th>
                            <th>Dirección</th>
                            <th>Puja</th>
                            <th>Total Inversión</th>
                            <th>Veredicto</th>
                            <th>Rentabilidad Media</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in analisis %}
                        <tr>
                            <td>{{ item.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                            <td>{{ item.identificador[:30] + '...' if item.identificador and item.identificador|length > 30 else item.identificador or 'N/A' }}</td>
                            <td>{{ item.direccion[:40] + '...' if item.direccion and item.direccion|length > 40 else item.direccion or 'N/A' }}</td>
                            <td class="text-right">
                                {{ '{:,.0f}'.format(item.puja).replace(',', 'X').replace('.', ',').replace('X', '.') if item.puja else '-' }} €
                            </td>
                            <td class="text-right">
                                <strong>{{ '{:,.0f}'.format(item.total_inversion).replace(',', 'X').replace('.', ',').replace('X', '.') if item.total_inversion else '-' }} €</strong>
                            </td>
                            <td>
                                {% if item.veredicto == 'ADJUDICADO' %}
                                    <span class="badge badge-success">{{ item.veredicto }}</span>
                                {% elif item.veredicto == 'POSIBLEMENTE' %}
                                    <span class="badge badge-warning">{{ item.veredicto }}</span>
                                {% elif item.veredicto %}
                                    <span class="badge badge-danger">{{ item.veredicto }}</span>
                                {% else %}
                                    <span class="badge badge-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td class="{{ 'text-success' if item.rentabilidad_medio and item.rentabilidad_medio > 0 else 'text-danger' }}">
                                {% if item.rentabilidad_medio %}
                                    <strong>{{ '{:.2f}'.format(item.rentabilidad_medio).replace('.', ',') }} %</strong>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('ver_analisis', analisis_id=item.id) }}" class="btn btn-sm btn-primary" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <form method="POST" action="{{ url_for('eliminar_analisis', analisis_id=item.id) }}" style="display: inline;" 
                                      onsubmit="return confirm('¿Estás seguro de eliminar este análisis?');">
                                    <button type="submit" class="btn btn-sm btn-danger" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <h5><i class="fas fa-info-circle"></i> No tienes análisis guardados</h5>
        <p class="mb-0">
            Comienza creando tu primer análisis de subasta.
            <a href="{{ url_for('nuevo_analisis') }}" class="alert-link">Crear análisis ahora</a>
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}
