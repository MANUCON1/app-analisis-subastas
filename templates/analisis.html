{% extends "base.html" %}

{% block title %}Nuevo Análisis - Subastas Visual{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>Nuevo Análisis de Subasta</h2>
            <hr>
        </div>
    </div>

    <form method="POST" action="{{ url_for('calcular_analisis') }}" id="formAnalisis">
        <!-- Sección 1: Extracción de datos -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">1. Extracción de Datos del BOE</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="url_subasta">URL de la Subasta (BOE):</label>
                    <div class="input-group">
                        <input type="url" class="form-control" id="url_subasta" name="url_subasta" 
                               placeholder="https://subastas.boe.es/...">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-success" id="btnExtraer">
                                <i class="fas fa-download"></i> Extraer y Rellenar
                            </button>
                        </div>
                    </div>
                    <small class="form-text text-muted">Pega la URL de la subasta del BOE para extraer los datos automáticamente.</small>
                </div>
                <div id="mensajeExtraccion" class="alert" style="display:none;"></div>
            </div>
        </div>

        <!-- Sección 2: Datos de la Subasta -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">2. Datos de la Subasta</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Identificador:</label>
                            <input type="text" class="form-control" name="identificador" id="identificador">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Fecha de conclusión:</label>
                            <input type="text" class="form-control" name="fecha_conclusion" id="fecha_conclusion">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Cantidad reclamada (€):</label>
                            <input type="number" step="0.01" class="form-control" name="cantidad_reclamada" id="cantidad_reclamada">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Valor subasta (€):</label>
                            <input type="number" step="0.01" class="form-control" name="valor_subasta" id="valor_subasta">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Tasación (€):</label>
                            <input type="number" step="0.01" class="form-control" name="tasacion" id="tasacion">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Tramos entre pujas (€):</label>
                            <input type="number" step="0.01" class="form-control" name="tramos_pujas" id="tramos_pujas">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Importe del depósito (€):</label>
                            <input type="number" step="0.01" class="form-control" name="deposito" id="deposito">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Dirección:</label>
                    <input type="text" class="form-control" name="direccion" id="direccion">
                </div>
                <div class="form-group">
                    <label>Referencia Catastral:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="referencia_catastral" id="referencia_catastral">
                        <div class="input-group-append">
                            <a href="https://www1.sedecatastro.gob.es/Cartografia/mapa.aspx" target="_blank" class="btn btn-outline-secondary">
                                <i class="fas fa-map"></i> Catastro
                            </a>
                            <a href="https://www.idealista.com/maps" target="_blank" class="btn btn-outline-secondary">
                                <i class="fas fa-search"></i> Idealista
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección 3: Puja -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">3. Tu Puja</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Puja Máxima (€):</label>
                            <input type="number" step="0.01" class="form-control" name="puja" id="puja" required>
                            <small class="form-text text-muted">Cantidad que estás dispuesto a pujar.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección 4: Datos de Rentabilidad -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">4. Análisis de Rentabilidad</h5>
            </div>
            <div class="card-body">
                <h6 class="text-primary">Costes Fijos (ITP y Notaría/Registro)</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Valor de Referencia Catastral (€):</label>
                            <input type="number" step="0.01" class="form-control" name="valor_referencia" id="valor_referencia">
                            <small class="form-text text-muted">Necesario para calcular ITP.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>ITP (%):</label>
                            <input type="number" step="0.1" class="form-control" name="itp_porcentaje" id="itp_porcentaje" value="7">
                            <small class="form-text text-muted">Varía según comunidad autónoma (7-10%).</small>
                        </div>
                    </div>
                </div>

                <hr>
                <h6 class="text-primary">Costes Judiciales</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Año del Procedimiento:</label>
                            <input type="number" class="form-control" name="ano_procedimiento" id="ano_procedimiento" 
                                   placeholder="2020" min="1990" max="2025">
                            <small class="form-text text-muted">Año en que comenzó el procedimiento judicial.</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>IBI Anual (€):</label>
                            <input type="number" step="0.01" class="form-control" name="ibi_anual" id="ibi_anual">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Comunidad Anual (€):</label>
                            <input type="number" step="0.01" class="form-control" name="comunidad_anual" id="comunidad_anual">
                        </div>
                    </div>
                </div>

                <hr>
                <h6 class="text-primary">Otros Costes</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Alarmas (€):</label>
                            <input type="number" step="0.01" class="form-control" name="alarmas" id="alarmas" value="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Suministros (€):</label>
                            <input type="number" step="0.01" class="form-control" name="suministros" id="suministros" value="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Reforma (€):</label>
                            <input type="number" step="0.01" class="form-control" name="reforma" id="reforma" value="0">
                        </div>
                    </div>
                </div>

                <hr>
                <h6 class="text-primary">Escenarios de Venta</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Precio Venta BAJO (€):</label>
                            <input type="number" step="0.01" class="form-control" name="venta_bajo" id="venta_bajo">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Precio Venta MEDIO (€):</label>
                            <input type="number" step="0.01" class="form-control" name="venta_medio" id="venta_medio">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Precio Venta ALTO (€):</label>
                            <input type="number" step="0.01" class="form-control" name="venta_alto" id="venta_alto">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección 5: Notas -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">5. Notas Adicionales (Opcional)</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <textarea class="form-control" name="notas" id="notas" rows="4" 
                              placeholder="Observaciones, contactos, estado del inmueble, etc."></textarea>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="row mb-4">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary btn-lg btn-block">
                    <i class="fas fa-calculator"></i> Calcular y Guardar Análisis
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-block mt-2">
                    Cancelar
                </a>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript para extracción automática -->
<script>
document.getElementById('btnExtraer').addEventListener('click', function() {
    const url = document.getElementById('url_subasta').value;
    const mensaje = document.getElementById('mensajeExtraccion');
    
    if (!url) {
        mensaje.className = 'alert alert-warning';
        mensaje.textContent = 'Por favor, introduce una URL válida.';
        mensaje.style.display = 'block';
        return;
    }
    
    // Mostrar mensaje de carga
    mensaje.className = 'alert alert-info';
    mensaje.textContent = 'Extrayendo datos... por favor espera.';
    mensaje.style.display = 'block';
    this.disabled = true;
    
    // Hacer petición AJAX
    fetch('{{ url_for("extraer_datos") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ url: url })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Rellenar los campos con los datos extraídos
            const datos = data.datos;
            document.getElementById('identificador').value = datos['Identificador'] || '';
            document.getElementById('fecha_conclusion').value = datos['Fecha de conclusión'] || '';
            document.getElementById('cantidad_reclamada').value = datos['Cantidad reclamada'] || '';
            document.getElementById('valor_subasta').value = datos['Valor subasta'] || '';
            document.getElementById('tasacion').value = datos['Tasación'] || '';
            document.getElementById('tramos_pujas').value = datos['Tramos entre pujas'] || '';
            document.getElementById('deposito').value = datos['Importe del depósito'] || '';
            document.getElementById('direccion').value = datos['Dirección'] || '';
            document.getElementById('referencia_catastral').value = datos['Referencia catastral'] || '';
            
            mensaje.className = 'alert alert-success';
            mensaje.textContent = '¡Datos extraídos correctamente!';
        } else {
            mensaje.className = 'alert alert-danger';
            mensaje.textContent = 'Error al extraer datos: ' + (data.error || 'Error desconocido');
        }
    })
    .catch(error => {
        mensaje.className = 'alert alert-danger';
        mensaje.textContent = 'Error de conexión: ' + error.
        mensaje.className = 'alert alert-danger';
        mensaje.textContent = 'Error de conexión: ' + error.message;
    })
    .finally(() => {
        document.getElementById('btnExtraer').disabled = false;
    });
});
</script>
{% endblock %}

